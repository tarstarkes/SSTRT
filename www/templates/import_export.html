<div id="header">
	<center>
		<h3>Import/Export</h3>
	</center>
</div>
<div id="body">
	<p>This is the Import/Export page</p>

	<center>
		<h3 id="race_id_label">Race ID:</h3>
		<p id="race_id"></p>
		<button id="import" class="ui_button" onclick="click_feedback(this);">IMPORT CLOUD DATA TO DEVICE</button>
		<button id="export" class="ui_button" onclick="click_feedback(this);">EXPORT DATA TO CLOUD</button>
		<button id="clear_device" class="ui_button" onclick="click_feedback(this);">CLEAR ALL DEVICE DATA</button>
	</center>
	<style>
		#clear_device,
		#import,
		#export{
			display: block;
			margin-top: 4vw;
			margin-bottom: 4vw; 
			padding: 4vw;
			font-size: 5vw
		}
		#race_id_label{
			margin-top:4vw;
			margin-bottom:0;
			font-size:4vw;
		}
		#race_id{
			margin-bottom:4vw;
			font-size: 6vw;
		}
	</style>
</div>
<script>
	$(document).ready(function(){
		var race = JSON.parse(window.localStorage.getItem('race'));

		$('#race_id').html(race.race_key);
		$('#clear_device').click(function(e){
			var answer = confirm("Are you sure you want to clear the current race data for this device?");
			if(answer == true){
				window.localStorage.removeItem('teams');
				window.localStorage.removeItem('current_leg');
				window.localStorage.removeItem('race');
				$('#race_id').remove();
			}
		});

		//LEG EXPORT FUNCTIONS---------------------------------------------

		function export_leg(t, team_object, leg_number){

		}
		function leg_export_call(t, team_object, leg_number){
			var Team = Parse.Object.extend("team");
			var team = new Team();
			race.id = team_object['id'];

			var Leg = Parse.Object.extend('leg');
			var leg = new Leg();

			leg_query = new Parse.Query(Leg);
			//CONTINUE HERE

		}
		function legs_export(t, team_object){
			for(var x; x < t.leg_time.length; x++){
				if(t.leg_time[x] != null && t.leg_time[x] != undefined){
					leg_export_call(t, team_object, leg_number);
				}
			}
		}
		//END LEG EXPORT ---------------------------------------------


		//TEAM EXPORT FUNCTIONS ---------------------------------------------
		function export_team(t, team, race_object){
			var Race = Parse.Object.extend("race");
			var race = new Race();
			race.id = race_object['id'];

			team.set('team_name', t.team_name);
			team.set('bib', t.bib_number);
			team.set('race_id', race);
			team.save(null, {
				success: function(results){
					console.log('TEAM data exported');
				},
				error: function(results, error){
					alert('failed to export team data: '+error.message);
				}
			});
		}

		function team_export_call(race_object, i){
			debugger;

			var Race = Parse.Object.extend("race");
			var race = new Race();
			race.id = race_object['id']

			var Teams = Parse.Object.extend("team");
			var team = new Teams();
			var t = JSON.parse(window.localStorage.getItem('teams'));

			teams_query = new Parse.Query(Teams);
			teams_query.equalTo('team_name', t[i].team_name);
			teams_query.equalTo('race_id', race);
			teams_query.find({
			success: function(results){
				var object;
				if(results.length > 0){
					for (var j = 0; j < results.length; j++) {
						object = results[j];
						yes_no = confirm("A team with the name "+t[i].team_name+" already exists in the database, do you want to overwrite that team?");
						if(yes_no == true){
							export_team(t[i], object, race_object);
						}
				    }
				}else{
					export_team(t[i], team, race_object);
				}
				legs_export(t[i], object);
			},
			error: function(error){
				alert('failed to export team data: '+error.message);
			}});
		}

		function teams_export(race_object){
			var t = JSON.parse(window.localStorage.getItem('teams'));
			for(var i=0; i < t.length; i++){
				debugger;
				team_export_call(race_object, i);
			}
		}
		//END TEAM EXPORT ---------------------------------------------


		//RACE EXPORT FUNCTIONS ---------------------------------------------
		function export_race(r, race){
			race.set('race_key', r.race_key);
			race.set('race_start_time', r.race_time);
			race.save(null, {
				success: function(results){
					alert("Export Operation Complete!");
				},
				error: function(results, error){
					alert('failed to export data: '+error.message);
				}
			});
		}

		$('#export').click(function(e){
			var Race = Parse.Object.extend("race");
			var race = new Race();
			var r = JSON.parse(window.localStorage.getItem('race'));

			//EXPORT RACE OBJECT
			//Test 1. Do we have data to upload?
			//Test 2. Does some/all of this data already exist on the server?
			//Teat 3. Does the user wish to overwrite the data if there is any already saved
			var race_query = new Parse.Query(Race);
			race_query.equalTo("race_key", r.race_key);
			race_query.find({
			success: function(results){
				var object;
				if(results.length > 0){
					for (var i = 0; i < results.length; i++) {
						object = results[i];
						race_time = object.get('race_start_time');
						race_key = object.get('race_key');
						yes_no = confirm("There is already a race with that key listed on the server, do you wish to overwrite the following data? race_start_time: "+race_time+", race_key: "+race_key);
						if(yes_no == true){
							export_race(r, object);
						}
				    }
				}else{
					export_race(r, race);
				}
				teams_export(object);
			},
			error: function(error){
				alert('failed to export data: '+error.message);
			}});
		});

		//END RACE EXPORT ---------------------------------------------
	});
</script>